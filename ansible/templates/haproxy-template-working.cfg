global
    log         127.0.0.1 local0
    chroot      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     2000000
    user        haproxy
    group       haproxy
    daemon
    stats socket /var/run/haproxy/admin1.sock mode 666 process 1
    nbproc 3
    cpu-map 1 0
    cpu-map 2 1
    cpu-map 3 2


defaults
    log                     global
    mode                    http
    option                  tcplog
    option                  dontlognull
    option http-server-close
    option                  redispatch
    retries                 3
    timeout http-request    10s
    timeout queue           1m
    timeout connect         10s
    timeout client          1m
    timeout server          1m
    timeout http-keep-alive 10s
    timeout check           10s
    maxconn                 2000000

frontend ws
    bind *:8000
    default_backend ws
    bind-process 1 2


frontend public
        bind *:80
        capture request header origin len 50
        acl is_websocket hdr(Upgrade) -i WebSocket
        acl is_websocket_path path_beg -i /socketcluster
        use_backend ws if is_websocket is_websocket_path
        default_backend www 
        bind-process 2 3 4 


backend ws
    balance leastconn
    server app1 10.0.40.27:8000 source 10.0.32.56
    server app2 10.0.40.27:8001 source 10.0.32.62
    server app3 10.0.40.27:8002 source 10.0.32.63
    server app4 10.0.40.27:8003 source 10.0.32.64
    server app5 10.0.40.28:8000 source 10.0.32.65
    server app6 10.0.40.28:8001 source 10.0.32.66
    server app7 10.0.40.28:8002 source 10.0.32.67
    server app8 10.0.40.28:8003 source 10.0.32.68



backend www
    http-response set-header Access-Control-Allow-Credentials true
        http-response set-header Access-Control-Allow-Origin %[capture.req.hdr(0)]
    reqrep ^([^\ ]*\ /)api[/]?(.*)     \1\2
    balance roundrobin
    fullconn 1000000
        server nginx1 10.0.40.27:7000 source 10.0.32.56
        server nginx_1 10.0.40.27:7001 source 10.0.32.56
        server nginx__1 10.0.40.27:7002 source 10.0.32.56
        server nginx___1 10.0.40.27:7003 source 10.0.32.56
        server nginx2 10.0.40.27:7000 source 10.0.32.62
        server nginx_2 10.0.40.27:7001 source 10.0.32.62
        server nginx__2 10.0.40.27:7002 source 10.0.32.62
        server nginx___2 10.0.40.27:7003 source 10.0.32.62
        server nginx3 10.0.40.27:7000 source 10.0.32.63
        server nginx_3 10.0.40.27:7001 source 10.0.32.63
        server nginx__3 10.0.40.27:7002 source 10.0.32.63
        server nginx___3 10.0.40.27:7003 source 10.0.32.63
        server nginx4 10.0.40.27:7000 source 10.0.32.64
        server nginx_4 10.0.40.27:7001 source 10.0.32.64
        server nginx__4 10.0.40.27:7002 source 10.0.32.64
        server nginx___4 10.0.40.27:7003 source 10.0.32.64
        server nginx5 10.0.40.27:7000 source 10.0.32.65
        server nginx_5 10.0.40.27:7001 source 10.0.32.65
        server nginx__5 10.0.40.27:7002 source 10.0.32.65
        server nginx___5 10.0.40.27:7003 source 10.0.32.65
        server nginx6 10.0.40.28:7000 source 10.0.32.66
        server nginx_6 10.0.40.28:7001 source 10.0.32.66
        server nginx__6 10.0.40.28:7002 source 10.0.32.66
        server nginx___6 10.0.40.28:7003 source 10.0.32.66
        server nginx7 10.0.40.28:7000 source 10.0.32.67
        server nginx_7 10.0.40.28:7001 source 10.0.32.67
        server nginx__7 10.0.40.28:7002 source 10.0.32.67
        server nginx___7 10.0.40.28:7003 source 10.0.32.67
        server nginx8 10.0.40.28:7000 source 10.0.32.68
        server nginx_8 10.0.40.28:7001 source 10.0.32.68
        server nginx__8 10.0.40.28:7002 source 10.0.32.68
        server nginx___8 10.0.40.28:7003 source 10.0.32.68
        server nginx9 10.0.40.28:7000 source 10.0.32.69
        server nginx_9 10.0.40.28:7001 source 10.0.32.69
        server nginx__9 10.0.40.28:7002 source 10.0.32.69
        server nginx___9 10.0.40.28:7003 source 10.0.32.69
        server nginx10 10.0.40.28:7000 source 10.0.32.70
        server nginx_10 10.0.40.28:7001 source 10.0.32.70
        server nginx__10 10.0.40.28:7002 source 10.0.32.70
        server nginx___10 10.0.40.28:7003 source 10.0.32.70
